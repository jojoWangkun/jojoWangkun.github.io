<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€èƒ½è¦†ç›–åˆ†æå¤§å±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4cc9f0;
            --bg: #0d1b2a;
            --bg2: #1b263b;
            --text: #fff;
            --muted: #ccc;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: var(--bg2);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        h1, h2, h3 {
            color: var(--primary);
        }

        .metric-card {
            background: var(--bg2);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            margin-bottom: 20px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
        }

        .metric-label {
            font-size: 14px;
            color: var(--muted);
        }

        hr {
            border: none;
            border-top: 1px solid rgba(255,255,255,.12);
            margin: 16px 0;
        }

        .card {
            background: var(--bg2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .chart-container {
            height: 400px;
            width: 100%;
        }

        button {
            background: var(--primary);
            color: #000;
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
        }

        button:hover {
            background: #4895ef;
            color: #fff;
        }

        input[type="file"] {
            width: 100%;
            margin: 10px 0;
            color: var(--text);
        }

        select, .multiselect {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--primary);
            margin: 5px 0;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .columns {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .column {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: var(--bg2);
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid rgba(255,255,255,0.1);
        }

        th {
            background: var(--bg);
        }

        .multiselect-container {
            position: relative;
        }

        .multiselect-options {
            position: absolute;
            width: 100%;
            background: var(--bg2);
            border: 1px solid var(--primary);
            border-radius: 5px;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .multiselect-options label {
            display: block;
            padding: 5px 10px;
            cursor: pointer;
        }

        .multiselect-options label:hover {
            background: var(--primary);
            color: #000;
        }

        .selected-items {
            margin-top: 5px;
        }

        .selected-item {
            display: inline-block;
            background: var(--primary);
            color: #000;
            padding: 2px 5px;
            border-radius: 3px;
            margin: 2px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h2>ğŸ“Š æ•°æ®æ§åˆ¶åŒº</h2>
            
            <div class="card">
                <input type="file" id="fileUpload" accept=".xlsx,.xls">
                
                <h3>é€‰æ‹©æ—¶é—´ç‚¹ï¼ˆæœˆæˆ–å­£ï¼‰</h3>
                <div class="multiselect-container">
                    <div class="multiselect" id="timeSelector">é€‰æ‹©æ—¶é—´ç‚¹...</div>
                    <div class="multiselect-options" id="timeOptions"></div>
                </div>
                <div class="selected-items" id="selectedTimes"></div>
                
                <h3>åˆ‡æ¢è§†å›¾</h3>
                <select id="viewSelector">
                    <option value="edit">ç¼–è¾‘æ•°æ®</option>
                    <option value="carousel">å¤§å±è½®æ’­</option>
                    <option value="single">å•é¡µæ¨¡å¼</option>
                    <option value="compare">èƒ½åŠ›å¯¹æ¯”</option>
                    <option value="all">æ˜¾ç¤ºæ‰€æœ‰è§†å›¾</option>
                </select>
                
                <div id="singlePageSelector" style="display: none;">
                    <h3>å•é¡µæŸ¥çœ‹</h3>
                    <select id="sectionSelector">
                        <option value="ranking">äººå‘˜å®Œæˆä»»åŠ¡æ•°é‡æ’å</option>
                        <option value="coverage">ä»»åŠ¡è¦†ç›–ç‡åˆ†å¸ƒ</option>
                        <option value="hot">ä»»åŠ¡æŒæ¡æƒ…å†µï¼ˆçƒ­é—¨ä»»åŠ¡ï¼‰</option>
                        <option value="heatmap">ä»»åŠ¡-äººå‘˜çƒ­åŠ›å›¾</option>
                        <option value="radar">äººå‘˜å¯¹æ¯”ï¼ˆé›·è¾¾å›¾ï¼‰</option>
                    </select>
                </div>
                
                <div id="personSelector" style="display: none;">
                    <h3>é€‰æ‹©äººå‘˜</h3>
                    <div class="multiselect-container">
                        <div class="multiselect" id="personMultiselect">é€‰æ‹©äººå‘˜...</div>
                        <div class="multiselect-options" id="personOptions"></div>
                    </div>
                    <div class="selected-items" id="selectedPersons"></div>
                </div>
                
                <button id="downloadTemplate">ä¸‹è½½æ¨¡æ¿</button>
                <button id="saveData">ä¿å­˜æ•°æ®</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <h1>ğŸ“Š æŠ€èƒ½è¦†ç›–åˆ†æå¤§å±</h1>
            
            <!-- æŒ‡æ ‡å¡ç‰‡ -->
            <div class="columns" id="metrics">
                <div class="column">
                    <div class="metric-card">
                        <div class="metric-value" id="totalTasks">0</div>
                        <div class="metric-label">ä»»åŠ¡æ•°</div>
                    </div>
                </div>
                <div class="column">
                    <div class="metric-card">
                        <div class="metric-value" id="totalPeople">0</div>
                        <div class="metric-label">äººæ•°</div>
                    </div>
                </div>
                <div class="column">
                    <div class="metric-card">
                        <div class="metric-value" id="topPerson">-</div>
                        <div class="metric-label">è¦†ç›–ç‡æœ€é«˜</div>
                    </div>
                </div>
                <div class="column">
                    <div class="metric-card">
                        <div class="metric-value" id="avgScore">0</div>
                        <div class="metric-label">å¹³å‡æ•°</div>
                    </div>
                </div>
            </div>
            
            <hr>
            
            <!-- è§†å›¾åŒºåŸŸ -->
            <div class="view-section active" id="editView">
                <h2>å½“å‰æ•°æ®è¡¨ï¼ˆè¡Œåˆå¹¶åï¼‰</h2>
                <div class="card">
                    <div id="dataTable"></div>
                </div>
            </div>
            
            <div class="view-section" id="carouselView">
                <h2>å¤§å±è½®æ’­</h2>
                <div class="card">
                    <div id="carouselChart" class="chart-container"></div>
                </div>
            </div>
            
            <div class="view-section" id="singleView">
                <h2 id="singleViewTitle">å•é¡µæ¨¡å¼</h2>
                <div class="card">
                    <div id="singleChart" class="chart-container"></div>
                </div>
            </div>
            
            <div class="view-section" id="compareView">
                <h2>èƒ½åŠ›å¯¹æ¯”</h2>
                <div class="card">
                    <div id="compareChart" class="chart-container"></div>
                </div>
            </div>
            
            <div class="view-section" id="allView">
                <h2>æ‰€æœ‰è§†å›¾</h2>
                
                <h3>äººå‘˜å®Œæˆä»»åŠ¡æ•°é‡æ’å</h3>
                <div class="card">
                    <div id="chart1" class="chart-container"></div>
                </div>
                
                <h3>ä»»åŠ¡è¦†ç›–ç‡åˆ†å¸ƒ</h3>
                <div class="card">
                    <div id="chart2" class="chart-container"></div>
                </div>
                
                <h3>ä»»åŠ¡æŒæ¡æƒ…å†µï¼ˆçƒ­é—¨ä»»åŠ¡ï¼‰</h3>
                <div class="card">
                    <div id="chart3" class="chart-container"></div>
                </div>
                
                <h3>äººå‘˜å¯¹æ¯”ï¼ˆé›·è¾¾å›¾ï¼‰</h3>
                <div class="card">
                    <div id="chart4" class="chart-container"></div>
                </div>
                
                <h3>ä»»åŠ¡-äººå‘˜çƒ­åŠ›å›¾</h3>
                <div class="card">
                    <div id="chart5" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let sheetData = {};
        let currentSheets = [];
        let currentData = [];
        let personColumns = [];
        let taskColumn = "æ˜ç»†";
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
            document.getElementById('viewSelector').addEventListener('change', handleViewChange);
            document.getElementById('sectionSelector').addEventListener('change', updateSingleView);
            document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
            document.getElementById('saveData').addEventListener('click', saveData);
            
            // åˆå§‹åŒ–å¤šé€‰ç»„ä»¶
            initMultiselect('timeOptions', 'selectedTimes', handleTimeSelection);
            
            // æ˜¾ç¤ºåˆå§‹è§†å›¾
            showView('edit');
            
            // åŠ è½½ç¤ºä¾‹æ•°æ®
            loadExampleData();
        });
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // æ¸…ç©ºç°æœ‰æ•°æ®
                sheetData = {};
                currentSheets = [];
                
                // å¤„ç†æ¯ä¸ªå·¥ä½œè¡¨
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    sheetData[sheetName] = jsonData;
                });
                
                // æ›´æ–°æ—¶é—´ç‚¹é€‰æ‹©
                updateTimeOptions();
                
                // é»˜è®¤é€‰æ‹©å‰3ä¸ªæ—¶é—´ç‚¹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                const sheetNames = Object.keys(sheetData);
                const defaultSelection = sheetNames.slice(0, Math.min(3, sheetNames.length));
                setSelectedTimes(defaultSelection);
                
                // å¤„ç†æ•°æ®
                processData();
            };
            reader.readAsArrayBuffer(file);
        }
        
        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadExampleData() {
            sheetData = {
                "ç¤ºä¾‹": [
                    { "ç¼–å·": 1, "æ˜ç»†": "ä»»åŠ¡A", "å¼ ä¸‰": 1, "æå››": 0, "ç‹äº”": 1 },
                    { "ç¼–å·": 2, "æ˜ç»†": "ä»»åŠ¡B", "å¼ ä¸‰": 0, "æå››": 1, "ç‹äº”": 1 },
                    { "ç¼–å·": 3, "æ˜ç»†": "ä»»åŠ¡C", "å¼ ä¸‰": 1, "æå››": 1, "ç‹äº”": 0 }
                ]
            };
            
            updateTimeOptions();
            setSelectedTimes(["ç¤ºä¾‹"]);
            processData();
        }
        
        // æ›´æ–°æ—¶é—´ç‚¹é€‰é¡¹
        function updateTimeOptions() {
            const timeOptions = document.getElementById('timeOptions');
            timeOptions.innerHTML = '';
            
            Object.keys(sheetData).forEach(sheetName => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = sheetName;
                checkbox.checked = currentSheets.includes(sheetName);
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(sheetName));
                timeOptions.appendChild(label);
            });
        }
        
        // è®¾ç½®é€‰ä¸­çš„æ—¶é—´ç‚¹
        function setSelectedTimes(times) {
            currentSheets = times;
            
            // æ›´æ–°UI
            const selectedTimes = document.getElementById('selectedTimes');
            selectedTimes.innerHTML = '';
            
            times.forEach(time => {
                const span = document.createElement('span');
                span.className = 'selected-item';
                span.textContent = time;
                selectedTimes.appendChild(span);
            });
            
            // å¤„ç†æ•°æ®
            processData();
        }
        
        // å¤„ç†æ—¶é—´ç‚¹é€‰æ‹©
        function handleTimeSelection(selectedValues) {
            setSelectedTimes(selectedValues);
        }
        
        // å¤„ç†æ•°æ®
        function processData() {
            if (currentSheets.length === 0) return;
            
            // åˆå¹¶é€‰ä¸­çš„å·¥ä½œè¡¨æ•°æ®
            let mergedData = [];
            currentSheets.forEach(sheetName => {
                if (sheetData[sheetName]) {
                    mergedData = mergedData.concat(sheetData[sheetName]);
                }
            });
            
            // æŒ‰ä»»åŠ¡åç§°åˆ†ç»„ï¼Œå–æœ€å¤§å€¼
            const taskMap = {};
            mergedData.forEach(row => {
                const taskName = row[taskColumn];
                if (!taskMap[taskName]) {
                    taskMap[taskName] = {...row};
                } else {
                    // å¯¹äºæ¯ä¸ªäººï¼Œå–æœ€å¤§å€¼
                    Object.keys(row).forEach(key => {
                        if (key !== "ç¼–å·" && key !== taskColumn) {
                            taskMap[taskName][key] = Math.max(taskMap[taskName][key] || 0, row[key] || 0);
                        }
                    });
                }
            });
            
            // è½¬æ¢å›æ•°ç»„
            currentData = Object.values(taskMap);
            
            // æå–äººå‘˜åˆ—
            personColumns = [];
            if (currentData.length > 0) {
                personColumns = Object.keys(currentData[0]).filter(
                    key => key !== "ç¼–å·" && key !== taskColumn
                );
            }
            
            // æ›´æ–°æŒ‡æ ‡
            updateMetrics();
            
            // æ›´æ–°æ•°æ®è¡¨æ ¼
            renderDataTable();
            
            // æ›´æ–°äººå‘˜é€‰æ‹©å™¨
            updatePersonSelector();
            
            // æ›´æ–°å›¾è¡¨
            updateAllCharts();
        }
        
        // æ›´æ–°æŒ‡æ ‡
        function updateMetrics() {
            document.getElementById('totalTasks').textContent = currentData.length;
            document.getElementById('totalPeople').textContent = personColumns.length;
            
            // è®¡ç®—æ¯ä¸ªäººçš„æ€»åˆ†
            const personScores = {};
            personColumns.forEach(person => {
                personScores[person] = 0;
                currentData.forEach(row => {
                    personScores[person] += row[person] || 0;
                });
            });
            
            // æ‰¾å‡ºæœ€é«˜åˆ†çš„äºº
            let topPerson = "-";
            let maxScore = 0;
            Object.keys(personScores).forEach(person => {
                if (personScores[person] > maxScore) {
                    maxScore = personScores[person];
                    topPerson = person;
                }
            });
            
            document.getElementById('topPerson').textContent = topPerson;
            
            // è®¡ç®—å¹³å‡åˆ†
            const totalScore = Object.values(personScores).reduce((a, b) => a + b, 0);
            const avgScore = personColumns.length > 0 ? (totalScore / personColumns.length).toFixed(1) : "0";
            document.getElementById('avgScore').textContent = avgScore;
        }
        
        // æ¸²æŸ“æ•°æ®è¡¨æ ¼
        function renderDataTable() {
            const tableContainer = document.getElementById('dataTable');
            
            if (currentData.length === 0) {
                tableContainer.innerHTML = '<p>æš‚æ— æ•°æ®</p>';
                return;
            }
            
            // åˆ›å»ºè¡¨æ ¼
            const table = document.createElement('table');
            
            // åˆ›å»ºè¡¨å¤´
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // æ·»åŠ åˆ—å¤´
            Object.keys(currentData[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // åˆ›å»ºè¡¨æ ¼ä¸»ä½“
            const tbody = document.createElement('tbody');
            
            // æ·»åŠ æ•°æ®è¡Œ
            currentData.forEach(row => {
                const tr = document.createElement('tr');
                
                Object.keys(row).forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = row[key];
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }
        
        // æ›´æ–°äººå‘˜é€‰æ‹©å™¨
        function updatePersonSelector() {
            const personOptions = document.getElementById('personOptions');
            personOptions.innerHTML = '';
            
            personColumns.forEach(person => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = person;
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(person));
                personOptions.appendChild(label);
            });
            
            // åˆå§‹åŒ–å¤šé€‰ï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
            if (!window.personMultiselectInitialized) {
                initMultiselect('personOptions', 'selectedPersons', handlePersonSelection);
                window.personMultiselectInitialized = true;
            }
        }
        
        // å¤„ç†äººå‘˜é€‰æ‹©
        function handlePersonSelection(selectedValues) {
            // åœ¨èƒ½åŠ›å¯¹æ¯”è§†å›¾ä¸­ä½¿ç”¨
            if (document.getElementById('viewSelector').value === 'compare') {
                updateCompareChart(selectedValues);
            }
            
            // åœ¨å•é¡µæ¨¡å¼çš„é›·è¾¾å›¾ä¸­ä½¿ç”¨
            if (document.getElementById('viewSelector').value === 'single' && 
                document.getElementById('sectionSelector').value === 'radar') {
                updateSingleView();
            }
        }
        
        // åˆå§‹åŒ–å¤šé€‰ç»„ä»¶
        function initMultiselect(optionsId, selectedId, changeCallback) {
            const multiselect = document.getElementById(optionsId).previousElementSibling;
            const options = document.getElementById(optionsId);
            const selected = document.getElementById(selectedId);
            
            // ç‚¹å‡»å¤šé€‰æ¡†æ˜¾ç¤º/éšè—é€‰é¡¹
            multiselect.addEventListener('click', function() {
                options.style.display = options.style.display === 'block' ? 'none' : 'block';
            });
            
            // é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            options.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT') {
                    updateSelectedItems();
                    
                    // è·å–æ‰€æœ‰é€‰ä¸­çš„å€¼
                    const selectedValues = [];
                    options.querySelectorAll('input:checked').forEach(checkbox => {
                        selectedValues.push(checkbox.value);
                    });
                    
                    // è°ƒç”¨å›è°ƒå‡½æ•°
                    if (changeCallback) {
                        changeCallback(selectedValues);
                    }
                }
            });
            
            // æ›´æ–°é€‰ä¸­é¡¹æ˜¾ç¤º
            function updateSelectedItems() {
                selected.innerHTML = '';
                
                options.querySelectorAll('input:checked').forEach(checkbox => {
                    const span = document.createElement('span');
                    span.className = 'selected-item';
                    span.textContent = checkbox.value;
                    selected.appendChild(span);
                });
            }
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—é€‰é¡¹
            document.addEventListener('click', function(e) {
                if (!multiselect.contains(e.target) && !options.contains(e.target)) {
                    options.style.display = 'none';
                }
            });
        }
        
        // å¤„ç†è§†å›¾åˆ‡æ¢
        function handleViewChange() {
            const view = document.getElementById('viewSelector').value;
            
            // æ˜¾ç¤º/éšè—ç›¸å…³æ§ä»¶
            document.getElementById('singlePageSelector').style.display = 
                view === 'single' ? 'block' : 'none';
            document.getElementById('personSelector').style.display = 
                (view === 'compare' || view === 'single') ? 'block' : 'none';
            
            // æ˜¾ç¤ºé€‰ä¸­çš„è§†å›¾
            showView(view);
            
            // æ›´æ–°å›¾è¡¨
            updateAllCharts();
        }
        
        // æ˜¾ç¤ºæŒ‡å®šè§†å›¾
        function showView(view) {
            // éšè—æ‰€æœ‰è§†å›¾
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„è§†å›¾
            document.getElementById(view + 'View').classList.add('active');
            
            // ç‰¹æ®Šå¤„ç†
            if (view === 'single') {
                updateSingleView();
            } else if (view === 'compare') {
                // é»˜è®¤é€‰æ‹©å‰ä¸¤ä¸ªäºº
                const defaultSelection = personColumns.slice(0, Math.min(2, personColumns.length));
                setSelectedPersons(defaultSelection);
                updateCompareChart(defaultSelection);
            } else if (view === 'carousel') {
                startCarousel();
            }
        }
        
        // è®¾ç½®é€‰ä¸­çš„äººå‘˜
        function setSelectedPersons(persons) {
            // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
            const options = document.getElementById('personOptions');
            options.querySelectorAll('input').forEach(checkbox => {
                checkbox.checked = persons.includes(checkbox.value);
            });
            
            // æ›´æ–°æ˜¾ç¤º
            const selected = document.getElementById('selectedPersons');
            selected.innerHTML = '';
            
            persons.forEach(person => {
                const span = document.createElement('span');
                span.className = 'selected-item';
                span.textContent = person;
                selected.appendChild(span);
            });
        }
        
        // æ›´æ–°å•é¡µè§†å›¾
        function updateSingleView() {
            const section = document.getElementById('sectionSelector').value;
            const chartDiv = document.getElementById('singleChart');
            const title = document.getElementById('singleViewTitle');
            
            // è®¾ç½®æ ‡é¢˜
            title.textContent = document.getElementById('sectionSelector').options[
                document.getElementById('sectionSelector').selectedIndex
            ].text;
            
            // æ ¹æ®é€‰æ‹©æ˜¾ç¤ºä¸åŒçš„å›¾è¡¨
            switch(section) {
                case 'ranking':
                    renderBarChart(chartDiv);
                    break;
                case 'coverage':
                    renderPieChart(chartDiv);
                    break;
                case 'hot':
                    renderHotTasksChart(chartDiv);
                    break;
                case 'heatmap':
                    renderHeatmap(chartDiv);
                    break;
                case 'radar':
                    // è·å–é€‰ä¸­çš„äººå‘˜
                    const selectedPersons = [];
                    document.getElementById('personOptions').querySelectorAll('input:checked').forEach(checkbox => {
                        selectedPersons.push(checkbox.value);
                    });
                    renderRadarChart(chartDiv, selectedPersons);
                    break;
            }
        }
        
        // æ›´æ–°å¯¹æ¯”å›¾è¡¨
        function updateCompareChart(selectedPersons) {
            renderRadarChart(document.getElementById('compareChart'), selectedPersons);
        }
        
        // æ›´æ–°æ‰€æœ‰å›¾è¡¨
        function updateAllCharts() {
            if (currentData.length === 0) return;
            
            renderBarChart(document.getElementById('chart1'));
            renderPieChart(document.getElementById('chart2'));
            renderHotTasksChart(document.getElementById('chart3'));
            
            // é»˜è®¤æ˜¾ç¤ºå‰3ä¸ªäºº
            const defaultPersons = personColumns.slice(0, Math.min(3, personColumns.length));
            renderRadarChart(document.getElementById('chart4'), defaultPersons);
            
            renderHeatmap(document.getElementById('chart5'));
        }
        
        // å¼€å§‹è½®æ’­
        function startCarousel() {
            const chartDiv = document.getElementById('carouselChart');
            const charts = [
                { title: "äººå‘˜å®Œæˆä»»åŠ¡æ•°é‡æ’å", render: () => renderBarChart(chartDiv) },
                { title: "ä»»åŠ¡è¦†ç›–ç‡åˆ†å¸ƒ", render: () => renderPieChart(chartDiv) },
                { title: "ä»»åŠ¡æŒæ¡æƒ…å†µï¼ˆçƒ­é—¨ä»»åŠ¡ï¼‰", render: () => renderHotTasksChart(chartDiv) },
                { title: "ä»»åŠ¡-äººå‘˜çƒ­åŠ›å›¾", render: () => renderHeatmap(chartDiv) }
            ];
            
            let currentIndex = 0;
            
            // å…ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªå›¾è¡¨
            charts[currentIndex].render();
            document.querySelector('#carouselView h2').textContent = charts[currentIndex].title;
            
            // è®¾ç½®è½®æ’­é—´éš”ï¼ˆ10ç§’ï¼‰
            setInterval(() => {
                currentIndex = (currentIndex + 1) % charts.length;
                charts[currentIndex].render();
                document.querySelector('#carouselView h2').textContent = charts[currentIndex].title;
            }, 10000);
        }
        
        // æ¸²æŸ“æŸ±çŠ¶å›¾ï¼ˆäººå‘˜å®Œæˆä»»åŠ¡æ•°é‡æ’åï¼‰
        function renderBarChart(container) {
            if (!container) return;
            
            // è®¡ç®—æ¯ä¸ªäººçš„æ€»åˆ†
            const personScores = {};
            personColumns.forEach(person => {
                personScores[person] = 0;
                currentData.forEach(row => {
                    personScores[person] += row[person] || 0;
                });
            });
            
            // æ’åº
            const sortedData = Object.entries(personScores)
                .sort((a, b) => b[1] - a[1]);
            
            const chart = echarts.init(container);
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: sortedData.map(item => item[0]),
                    axisLabel: {
                        color: '#fff'
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        color: '#fff'
                    }
                },
                series: [{
                    data: sortedData.map(item => item[1]),
                    type: 'bar',
                    itemStyle: {
                        color: '#4cc9f0'
                    }
                }]
            };
            
            chart.setOption(option);
        }
        
        // æ¸²æŸ“é¥¼å›¾ï¼ˆä»»åŠ¡è¦†ç›–ç‡åˆ†å¸ƒï¼‰
        function renderPieChart(container) {
            if (!container) return;
            
            // è®¡ç®—æ¯ä¸ªä»»åŠ¡è¢«å¤šå°‘äººæŒæ¡
            const coverageCount = {};
            currentData.forEach(row => {
                let count = 0;
                personColumns.forEach(person => {
                    if (row[person]) count++;
                });
                
                if (!coverageCount[count]) {
                    coverageCount[count] = 0;
                }
                coverageCount[count]++;
            });
            
            // è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®
            const chartData = Object.entries(coverageCount).map(([count, tasks]) => ({
                name: `${count}äººæŒæ¡`,
                value: tasks
            }));
            
            const chart = echarts.init(container);
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: chartData,
                    label: {
                        color: '#fff'
                    }
                }]
            };
            
            chart.setOption(option);
        }
        
        // æ¸²æŸ“çƒ­é—¨ä»»åŠ¡å›¾è¡¨
        function renderHotTasksChart(container) {
            if (!container) return;
            
            // è®¡ç®—æ¯ä¸ªä»»åŠ¡è¢«æŒæ¡çš„æ€»æ¬¡æ•°
            const taskPopularity = currentData.map(row => {
                let count = 0;
                personColumns.forEach(person => {
                    if (row[person]) count++;
                });
                return {
                    name: row[taskColumn],
                    value: count
                };
            });
            
            // æŒ‰æŒæ¡æ¬¡æ•°æ’åº
            taskPopularity.sort((a, b) => b.value - a.value);
            
            const chart = echarts.init(container);
            const option = {
                backgroundColor: 'transparent',
                yAxis: {
                    type: 'category',
                    data: taskPopularity.map(item => item.name),
                    axisLabel: {
                        color: '#fff'
                    }
                },
                xAxis: {
                    type: 'value',
                    axisLabel: {
                        color: '#fff'
                    }
                },
                series: [{
                    data: taskPopularity.map(item => item.value),
                    type: 'bar',
                    itemStyle: {
                        color: '#ffb703'
                    }
                }]
            };
            
            chart.setOption(option);
        }
        
        // æ¸²æŸ“é›·è¾¾å›¾
        function renderRadarChart(container, selectedPersons) {
            if (!container || !selectedPersons || selectedPersons.length === 0) return;
            
            // å‡†å¤‡æ•°æ®
            const indicators = currentData.map(row => ({
                name: row[taskColumn],
                max: 1
            }));
            
            const seriesData = selectedPersons.map(person => {
                return {
                    name: person,
                    value: currentData.map(row => row[person] || 0)
                };
            });
            
            const chart = echarts.init(container);
            const option = {
                backgroundColor: 'transparent',
                legend: {
                    data: selectedPersons,
                    textStyle: {
                        color: '#fff'
                    }
                },
                radar: {
                    indicator: indicators
                },
                series: [{
                    type: 'radar',
                    data: seriesData
                }]
            };
            
            chart.setOption(option);
        }
        
        // æ¸²æŸ“çƒ­åŠ›å›¾
        function renderHeatmap(container) {
            if (!container) return;
            
            const data = [];
            
            // å‡†å¤‡æ•°æ®
            currentData.forEach((row, taskIndex) => {
                personColumns.forEach((person, personIndex) => {
                    data.push([personIndex, taskIndex, row[person] || 0]);
                });
            });
            
            const chart = echarts.init(container);
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    position: 'top'
                },
                xAxis: {
                    type: 'category',
                    data: personColumns,
                    axisLabel: {
                        color: '#fff'
                    }
                },
                yAxis: {
                    type: 'category',
                    data: currentData.map(row => row[taskColumn]),
                    axisLabel: {
                        color: '#fff'
                    }
                },
                visualMap: {
                    min: 0,
                    max: 1,
                    calculable: true,
                    orient: 'horizontal',
                    textStyle: {
                        color: '#fff'
                    }
                },
                series: [{
                    type: 'heatmap',
                    data: data
                }]
            };
            
            chart.setOption(option);
        }
        
        // ä¸‹è½½æ¨¡æ¿
        function downloadTemplate() {
            // åˆ›å»ºç¤ºä¾‹æ•°æ®
            const templateData = [
                { "ç¼–å·": 1, "æ˜ç»†": "ä»»åŠ¡A", "å¼ ä¸‰": 1, "æå››": 0, "ç‹äº”": 0 },
                { "ç¼–å·": 2, "æ˜ç»†": "ä»»åŠ¡B", "å¼ ä¸‰": 0, "æå››": 1, "ç‹äº”": 0 },
                { "ç¼–å·": 3, "æ˜ç»†": "ä»»åŠ¡C", "å¼ ä¸‰": 0, "æå››": 0, "ç‹äº”": 1 }
            ];
            
            // åˆ›å»ºå·¥ä½œç°¿
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç¤ºä¾‹");
            
            // ç”ŸæˆExcelæ–‡ä»¶
            XLSX.writeFile(wb, "æŠ€èƒ½è¦†ç›–åˆ†ææ¨¡æ¿.xlsx");
        }
        
        // ä¿å­˜æ•°æ®
        function saveData() {
            if (currentData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä¿å­˜');
                return;
            }
            
            // åˆ›å»ºå·¥ä½œç°¿
            const ws = XLSX.utils.json_to_sheet(currentData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åˆ†æç»“æœ");
            
            // ç”ŸæˆExcelæ–‡ä»¶
            XLSX.writeFile(wb, "æŠ€èƒ½è¦†ç›–åˆ†æç»“æœ.xlsx");
        }
    </script>
</body>
</html>